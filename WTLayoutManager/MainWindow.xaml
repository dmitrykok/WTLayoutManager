<Window x:Class="WTLayoutManager.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Style="{StaticResource MaterialDesignWindow}"
        Title="WT Layout Manager" Height="600" Width="800"
        xmlns:converters="clr-namespace:WTLayoutManager.Converters">
    
    <Window.Resources>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <Style x:Key="MyCustomDataGridRowStyle"
               TargetType="DataGridRow"
               BasedOn="{StaticResource {x:Type DataGridRow}}">
            <!-- We start with the MD style for DataGridRow, then add our triggers. -->
            <Setter Property="DetailsVisibility" Value="Collapsed"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                    <Setter Property="DetailsVisibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- ComboBox for installed terminals -->
        <ComboBox
              Grid.Row="0"
              ItemsSource="{Binding Terminals}"
              SelectedItem="{Binding SelectedTerminal}"
              Margin="0,0,0,5"
              Width="500">
            <ComboBox.ItemTemplate>
                <DataTemplate>
                    <StackPanel Orientation="Horizontal">
                        <Image
                            Width="20"
                            Height="20"
                            Margin="0,0,5,0"
                            Source="{Binding ImageSource}" />
                        <TextBlock Text="{Binding DisplayName}" />
                    </StackPanel>
                </DataTemplate>
            </ComboBox.ItemTemplate>
        </ComboBox>

        <!-- Search Box with Clear Button -->
        <Grid Grid.Row="1" Margin="0,0,0,5">
            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                     materialDesign:HintAssist.Hint="Search folders..."
                     x:Name="SearchTextBox"
                     FontWeight="Bold"
                     CaretBrush="Red"
                     Foreground="White"
                     Height="25"
                     Padding="5,0,30,0"/>

            <!-- Clear button -->
            <Button Style="{StaticResource MaterialDesignIconButton}"
                    Width="24"
                    Height="24"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Margin="0,0,5,0"
                    Padding="0"
                    ToolTip="Clear search"
                    Command="{Binding ClearSearchCommand}"
                    Visibility="{Binding Text.Length, ElementName=SearchTextBox, Converter={StaticResource IntToVisibilityConverter}}">
                <materialDesign:PackIcon Kind="CloseBold"/>
            </Button>
        </Grid>

        <!-- Main DataGrid -->
        <DataGrid Grid.Row="2" 
              ItemsSource="{Binding FoldersView}"
              RowStyle="{StaticResource MyCustomDataGridRowStyle}"
              AutoGenerateColumns="False"
              IsReadOnly="False"
              SelectionMode="Single"
              CanUserSortColumns="True">

            <!-- Sortable columns: +/-, folder name, last run, buttons -->
            <DataGrid.Columns>
                <!-- Expand/Collapse column -->
                <DataGridTemplateColumn Header=" #" 
                                        IsReadOnly="True" 
                                        Width="50" 
                                        MinWidth="50" 
                                        MaxWidth="50" 
                                        CanUserReorder="False" 
                                        CanUserSort="False">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button FontWeight="ExtraBold" Content="{Binding ExpandCollapseIndicator}"
                                        Command="{Binding ToggleExpandCollapseCommand}"
                                        Width="30"
                                        ToolTip="Expand/Collapse"
                                        Margin="0,0,-5,0"
                                        Padding="0,0,0,0"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Folder Name -->
                <DataGridTemplateColumn Header="Folder Name" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center">
                                <TextBlock.InputBindings>
                                    <MouseBinding Gesture="LeftDoubleClick"
                                                  Command="{Binding EditFolderCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                  CommandParameter="{Binding}"/>
                                </TextBlock.InputBindings>
                            </TextBlock>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>


                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBox Grid.Column="0" 
                                         Cursor="Pen" 
                                         Text="{Binding Name, UpdateSourceTrigger=Explicit}" 
                                         VerticalAlignment="Center" 
                                         x:Name="EditTextBox" 
                                         Loaded="EditTextBox_Loaded"
                                         FontWeight="Bold"
                                         CaretBrush="Red"
                                         Foreground="White"/>

                                <Button Grid.Column="1" Content="✔" Click="ConfirmEdit_Click" Margin="2,0" Command="{Binding EditFolderCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                <Button Grid.Column="2" Content="✖" Click="CancelEdit_Click" Margin="2,0" Command="{Binding EditFolderCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Last Run -->
                <DataGridTextColumn Header="Last Run"
                            Binding="{Binding LastRun, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}"
                            SortMemberPath="LastRun"
                            Width="150"
                            IsReadOnly="True"/>

                <!-- Action Buttons -->
                <DataGridTemplateColumn Header="Actions" 
                                        IsReadOnly="True" 
                                        Width="160" 
                                        MinWidth="160" 
                                        MaxWidth="160" 
                                        CanUserResize="False" 
                                        CanUserReorder="False" 
                                        CanUserSort="False">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <!-- Run button -->
                                <Button Content="{materialDesign:PackIcon Kind=PlayCircleOutline}" 
                                        Command="{Binding RunCommand}"
                                        ToolTip="Run" 
                                        Margin="0,0,0,0" 
                                        Padding="5,0,5,0" />
                                <!-- Run as Admin -->
                                <Button Content="{materialDesign:PackIcon Kind=ShieldCrownOutline}" 
                                        Command="{Binding RunAsCommand}"
                                        ToolTip="Run as Admin" 
                                        Margin="0,0,0,0" 
                                        Padding="5,0,5,0" />
                                <!-- Duplicate -->
                                <Button Content="{materialDesign:PackIcon Kind=ContentDuplicate}"
                                        Command="{Binding DuplicateCommand}" 
                                        ToolTip="Duplicate" 
                                        Margin="0,0,0,0" 
                                        Padding="5,0,5,0" />
                                <!-- Delete -->
                                <Button Content="{materialDesign:PackIcon Kind=TrashCanOutline}"
                                        Command="{Binding DeleteCommand}"
                                        IsEnabled="{Binding CanDelete}"
                                        ToolTip="Delete" 
                                        Margin="0,0,0,0" 
                                        Padding="5,0,5,0" />
                                <!-- Open folder -->
                                <Button Content="{materialDesign:PackIcon Kind=FolderEyeOutline}"
                                        Command="{Binding OpenFolderCommand}" 
                                        ToolTip="{Binding Path}" 
                                        Margin="0,0,0,0" 
                                        Padding="5,0,5,0" />
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>

            <!-- RowDetails for sub-grid -->
            <DataGrid.RowDetailsTemplate>
                <DataTemplate>
                    <!-- Sub-DataGrid showing the files -->
                    <DataGrid ItemsSource="{Binding Files}"
                            AutoGenerateColumns="False"
                            CanUserAddRows="False"
                            HeadersVisibility="Column"
                            IsReadOnly="True"
                            ToolTip="{Binding Path}"
                            Margin="30,0,0,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Filename" Binding="{Binding FileName}" Width="Auto" />
                            <DataGridTextColumn Header="Modified" Binding="{Binding LastModified, StringFormat={}{0:yyyy-MM-dd HH:mm:ss}}" Width="Auto"/>
                            <DataGridTextColumn Header="Size" Binding="{Binding Size}" Width="Auto"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DataTemplate>
            </DataGrid.RowDetailsTemplate>

        </DataGrid>
    </Grid>
</Window>
